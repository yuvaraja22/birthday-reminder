<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moments</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="manifest" href="manifest.json">

    <!-- PWA Settings -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Moments">



    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        success: '#10b981',
                        danger: '#ef4444',
                        bg: '#f8fafc',
                        card: '#ffffff'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        input,
        select {
            font-size: 16px !important;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-animate {
            animation: slideUp 0.3s ease-out forwards;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Card Interactions */
        .birthday-card {
            transition: transform 0.2s, box-shadow 0.2s;
            aspect-ratio: 2/3;
            /* Enforce 4x6 portrait ratio */
        }

        .birthday-card:active {
            transform: scale(0.96);
        }
    </style>
</head>

<body class="bg-bg text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="px-6 pt-6 pb-4 bg-white shadow-sm z-10 flex-shrink-0">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Moments</h1>
                <p class="text-xs text-slate-500" id="currentDateDisplay">Loading...</p>
            </div>
            <div class="flex gap-3 items-center">
                <button id="login-btn" onclick="googleLogin()"
                    class="hidden bg-white border border-slate-200 text-slate-600 px-3 h-10 rounded-full flex items-center gap-2 text-xs font-bold hover:bg-slate-50 transition">
                    <i class="fa-brands fa-google text-red-500"></i> Sync
                </button>

                <button onclick="openSettingsModal()"
                    class="bg-slate-100 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition">
                    <i class="fa-solid fa-gear"></i>
                </button>

                <button onclick="requestNotificationPermission()"
                    class="bg-slate-100 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition">
                    <i class="fa-solid fa-bell"></i>
                </button>

                <div id="user-profile" class="hidden relative flex items-center gap-2">
                    <img id="user-avatar" src="" onclick="toggleProfileMenu()"
                        class="w-10 h-10 rounded-full border-2 border-white shadow-sm cursor-pointer hover:scale-105 transition"
                        alt="User">

                    <!-- Dropdown Menu -->
                    <div id="profile-menu"
                        class="hidden absolute top-12 right-0 bg-white shadow-xl rounded-xl p-1 z-50 min-w-[140px] border border-slate-100">
                        <button onclick="googleLogout()"
                            class="w-full text-left text-sm text-red-500 font-medium hover:bg-red-50 px-3 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-right-from-bracket"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center">
            <p id="storage-indicator" class="text-xs text-slate-500 flex items-center gap-1">
                <i class="fa-solid fa-database"></i> <span>Local Storage</span>
            </p>
            <select id="filterType" onchange="renderList()"
                class="bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="All">All Types</option>
                <option value="Birthday">Birthdays</option>
                <option value="Anniversary">Anniversaries</option>
                <option value="Other">Other</option>
            </select>
        </div>
    </header>

    <!-- Install App Banner -->
    <div id="install-banner"
        class="hidden bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 shadow-lg z-20">
        <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 flex-1">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-download text-blue-600 text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm">Install Moments</p>
                    <p class="text-xs text-blue-100">Add to home screen for quick access</p>
                </div>
            </div>
            <div class="flex gap-2 flex-shrink-0">
                <button onclick="installApp()"
                    class="bg-white text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-50 active:scale-95 transition">
                    Install
                </button>
                <button onclick="dismissInstallBanner()" class="text-white hover:text-blue-100 p-2">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 w-full max-w-md mx-auto" id="appContent">
        <!-- Summary Card -->
        <div
            class="bg-gradient-to-br from-primary to-blue-600 rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
            <p class="text-blue-100 text-sm font-medium mb-1">Moments Overview</p>
            <h2 class="text-3xl font-bold tracking-tight mb-4" id="total-count">0 Moments</h2>

            <div class="flex gap-4">
                <div class="flex-1 bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-5 h-5 rounded-full bg-yellow-400/30 flex items-center justify-center">
                            <i class="fa-solid fa-calendar-day text-yellow-300 text-[10px]"></i>
                        </div>
                        <span class="text-xs text-blue-50">This Month</span>
                    </div>
                    <p class="font-semibold text-lg" id="this-month-count">0</p>
                </div>
                <div class="flex-1 bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-5 h-5 rounded-full bg-green-400/30 flex items-center justify-center">
                            <i class="fa-solid fa-star text-green-300 text-[10px]"></i>
                        </div>
                        <span class="text-xs text-blue-50">Today</span>
                    </div>
                    <p class="font-semibold text-lg" id="today-count">0</p>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
            <i class="fa-regular fa-calendar-plus text-4xl mb-3 opacity-50"></i>
            <p class="text-sm">No moments yet.</p>
        </div>

        <!-- Birthday List -->
        <div id="birthdayList" class="space-y-3">
            <!-- Cards injected via JS -->
        </div>
    </main>

    <!-- Floating Action Button -->
    <button id="fabButton" onclick="openModal()"
        class="fixed bottom-6 right-6 bg-primary text-white w-14 h-14 rounded-full shadow-xl shadow-blue-500/40 flex items-center justify-center text-2xl hover:bg-blue-700 active:scale-90 transition-all duration-300 z-30">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Add/Edit Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity"
        onclick="closeModalOutside(event)">
        <div id="modalContent"
            class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 modal-animate max-w-md mx-auto w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-900" id="modalTitle">Add Moment</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <form id="birthdayForm" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="editId">

                <div class="mb-4">
                    <label class="block text-slate-500 text-xs font-semibold uppercase mb-1">Name</label>
                    <div class="relative">
                        <i class="fa-regular fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="nameInput" required placeholder="e.g. John Doe"
                            class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white transition">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-slate-500 text-xs font-semibold uppercase mb-1">Type</label>
                    <select id="typeInput" onchange="toggleCustomType()"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white transition text-slate-700 appearance-none">
                        <option value="Birthday">Birthday üéÇ</option>
                        <option value="Anniversary">Anniversary üíç</option>
                        <option value="Other">Other ‚ú®</option>
                    </select>
                </div>

                <div id="customTypeContainer" class="mb-4 hidden">
                    <label class="block text-slate-500 text-xs font-semibold uppercase mb-1">Custom Label</label>
                    <input type="text" id="customTypeInput" placeholder="e.g. Graduation"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white transition">
                </div>

                <div class="mb-6">
                    <label class="block text-slate-500 text-xs font-semibold uppercase mb-1">Date</label>
                    <input type="date" id="dateInput" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white transition text-slate-700">
                </div>

                <div class="flex gap-3">
                    <button type="button" id="deleteBtn" onclick="deleteBirthday()"
                        class="hidden flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold hover:bg-red-100 active:scale-95 transition">
                        Delete
                    </button>
                    <button type="submit"
                        class="flex-1 bg-primary text-white py-4 rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition shadow-lg shadow-blue-500/30">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4 sm:p-0"
        style="display: none;">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeSettingsModal()"></div>

        <div
            class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 relative shadow-2xl z-10 mb-0 sm:mb-0 modal-animate max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-900">Notification Settings</h3>
                <button onclick="closeSettingsModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <!-- Enable/Disable Toggle -->
            <div class="mb-6 pb-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-slate-800">Enable Notifications</p>
                        <p class="text-xs text-slate-500 mt-0.5">Get reminders for upcoming moments</p>
                    </div>
                    <label class="relative inline-block w-12 h-6">
                        <input type="checkbox" id="notifications-enabled" onchange="toggleNotifications()"
                            class="sr-only peer">
                        <div
                            class="w-12 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-6 peer-checked:bg-primary after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all">
                        </div>
                    </label>
                </div>
            </div>

            <!-- Reminders List -->
            <div class="mb-6">
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-3">Reminder Times</label>
                <div id="reminders-list" class="space-y-2 mb-4">
                    <!-- Reminders will be inserted here -->
                </div>
            </div>

            <!-- Add Reminder Section -->
            <div class="mb-4">
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Add Reminder</label>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="addReminderPreset(12, '12 hours before')"
                        class="bg-slate-50 hover:bg-slate-100 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium transition active:scale-95">
                        12 hours before
                    </button>
                    <button onclick="addReminderPreset(24, '1 day before')"
                        class="bg-slate-50 hover:bg-slate-100 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium transition active:scale-95">
                        1 day before
                    </button>
                    <button onclick="addReminderPreset(48, '2 days before')"
                        class="bg-slate-50 hover:bg-slate-100 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium transition active:scale-95">
                        2 days before
                    </button>
                    <button onclick="addReminderPreset(168, '1 week before')"
                        class="bg-slate-50 hover:bg-slate-100 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium transition active:scale-95">
                        1 week before
                    </button>
                </div>

                <div class="flex gap-2">
                    <input type="number" id="custom-hours" placeholder="Hours" min="0"
                        class="flex-1 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white text-sm">
                    <button onclick="addCustomReminder()"
                        class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 active:scale-95 transition">
                        Add Custom
                    </button>
                </div>
            </div>

            <button onclick="closeSettingsModal()"
                class="w-full bg-slate-100 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-200 active:scale-95 transition">
                Close
            </button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast"
        class="fixed top-4 left-4 right-4 bg-slate-800 text-white p-4 rounded-xl shadow-2xl transform -translate-y-40 transition-transform duration-300 z-50 flex items-center gap-3 justify-center">
        <i class="fa-solid fa-circle-info text-blue-400" id="toastIcon"></i>
        <span id="toastMsg" class="font-medium text-sm">Action Successful</span>
    </div>



    <script>
        // ==========================================
        // FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyC5bgHDNhcrJfhSweCQz0CA0uEEuc05um0",
            authDomain: "birthday-reminder-yuva.firebaseapp.com",
            projectId: "birthday-reminder-yuva",
            storageBucket: "birthday-reminder-yuva.firebasestorage.app",
            messagingSenderId: "615674453004",
            appId: "1:615674453004:web:3d4e6d8f9030645249a229",
            measurementId: "G-6ZVBS4Y7TX"
        };
        let auth, db, currentUser = null;
        let isFirebaseReady = false;

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;

            auth.onAuthStateChanged(async (user) => {
                const wasLoggedOut = currentUser === null;
                currentUser = user;
                updateAuthUI(user);

                if (user && wasLoggedOut) {
                    // User just logged in - sync local data to cloud first
                    await syncLocalToCloud();
                } else if (user) {
                    // User was already logged in - just load cloud data
                    loadFromCloud();
                } else {
                    // User is logged out - load from local storage
                    loadFromLocal();
                }
            });
        } catch (e) {
            console.error("Firebase Init Error:", e);
            loadFromLocal();
        }


        // --- PWA Install Logic ---
        let deferredPrompt;

        // Capture the install prompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing
            e.preventDefault();
            // Save the event for later use
            deferredPrompt = e;

            // Check if user has dismissed the banner before
            const dismissed = localStorage.getItem('install-banner-dismissed');
            if (!dismissed) {
                // Show the install banner
                document.getElementById('install-banner').classList.remove('hidden');
            }
        });

        async function installApp() {
            if (!deferredPrompt) {
                // For iOS: Show instructions since PWA install is not available via API
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    alert('To install:\n1. Tap the Share button\n2. Scroll and tap "Add to Home Screen"\n3. Tap "Add"');
                }
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user's response
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }

            // Clear the deferredPrompt
            deferredPrompt = null;

            // Hide the banner
            document.getElementById('install-banner').classList.add('hidden');
        }

        function dismissInstallBanner() {
            document.getElementById('install-banner').classList.add('hidden');
            // Remember that user dismissed the banner (for 30 days)
            localStorage.setItem('install-banner-dismissed', Date.now());
            setTimeout(() => {
                localStorage.removeItem('install-banner-dismissed');
            }, 30 * 24 * 60 * 60 * 1000); // 30 days
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            document.getElementById('install-banner').classList.add('hidden');
        });

        // ==========================================
        // APP LOGIC
        // ==========================================
        let birthdays = [];
        let notificationSettings = {
            enabled: true,
            reminders: [
                { id: 'default', label: 'Day of (12 AM)', hours: 0 }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentDate();
            setupManifest();
            loadNotificationSettings();
            if (!isFirebaseReady) loadFromLocal();
        });

        // --- Auth Functions ---
        function googleLogin() {
            if (!isFirebaseReady) return alert("Firebase not configured.");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => alert(err.message));
        }

        function googleLogout() {
            auth.signOut();
            birthdays = [];
            loadFromLocal();
        }

        function updateAuthUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userProfile = document.getElementById('user-profile');
            const userAvatar = document.getElementById('user-avatar');
            const storageInd = document.getElementById('storage-indicator');

            if (user) {
                loginBtn.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userAvatar.src = user.photoURL;
                storageInd.innerHTML = `<i class="fa-brands fa-google"></i> <span>Synced to Cloud</span>`;
            } else {
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden');
                storageInd.innerHTML = `<i class="fa-solid fa-database"></i> <span>Local Storage</span>`;
            }
            document.getElementById('profile-menu').classList.add('hidden');
        }

        function toggleProfileMenu() {
            document.getElementById('profile-menu').classList.toggle('hidden');
        }

        // --- Data Handling ---

        function loadFromLocal() {
            const stored = localStorage.getItem('birthdays');
            birthdays = stored ? JSON.parse(stored) : [];
            renderList();
        }

        async function syncLocalToCloud() {
            if (!currentUser || !isFirebaseReady) return;

            // Get local storage data
            const stored = localStorage.getItem('birthdays');
            const localBirthdays = stored ? JSON.parse(stored) : [];

            if (localBirthdays.length === 0) {
                // No local data to sync, just load from cloud
                loadFromCloud();
                return;
            }

            try {
                const userRef = db.collection('users').doc(currentUser.uid).collection('birthdays');

                // Fetch existing cloud data
                const snapshot = await userRef.get();
                const cloudBirthdays = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Deduplicate: only add local items that don't exist in cloud
                // Duplicate check: same name (case-insensitive) AND same date
                const newEntries = localBirthdays.filter(local => {
                    const isDuplicate = cloudBirthdays.some(cloud =>
                        cloud.name.toLowerCase() === local.name.toLowerCase() &&
                        cloud.date === local.date
                    );
                    return !isDuplicate;
                });

                // Upload new entries to cloud
                const uploadPromises = newEntries.map(entry => {
                    const { id, ...data } = entry; // Remove local ID
                    return userRef.add(data);
                });

                await Promise.all(uploadPromises);

                // Clear local storage after successful sync
                localStorage.removeItem('birthdays');

                // Show sync result to user
                if (newEntries.length > 0) {
                    showToast(`Synced ${newEntries.length} moment${newEntries.length > 1 ? 's' : ''} to cloud!`);
                } else {
                    showToast('All moments already synced!');
                }

                // Now load from cloud (will set up real-time listener)
                loadFromCloud();
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Sync failed. Loading cloud data...', true);
                loadFromCloud();
            }
        }

        function loadFromCloud() {
            if (!currentUser) return;
            const userRef = db.collection('users').doc(currentUser.uid).collection('birthdays');

            userRef.onSnapshot(snapshot => {
                birthdays = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderList();
            });
        }

        function saveData(birthdayData, isDelete = false, idToDelete = null) {
            if (currentUser && isFirebaseReady) {
                // Cloud Mode
                const userRef = db.collection('users').doc(currentUser.uid).collection('birthdays');
                if (isDelete && idToDelete) {
                    userRef.doc(idToDelete).delete();
                } else if (birthdayData) {
                    if (birthdayData.id) {
                        const { id, ...data } = birthdayData;
                        userRef.doc(id).set(data);
                    } else {
                        userRef.add(birthdayData);
                    }
                }
            } else {
                // Local Mode
                if (isDelete && idToDelete) {
                    birthdays = birthdays.filter(b => b.id !== idToDelete);
                } else if (birthdayData) {
                    const index = birthdays.findIndex(b => b.id === birthdayData.id);
                    if (index !== -1) {
                        birthdays[index] = birthdayData;
                    } else {
                        birthdays.push(birthdayData);
                    }
                }
                localStorage.setItem('birthdays', JSON.stringify(birthdays));
                renderList();
            }
        }

        // --- Business Logic ---

        function updateCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('en-US', options);
        }

        function getNextBirthday(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const birthDate = new Date(dateStr);
            let nextBday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());

            if (nextBday < today) {
                nextBday.setFullYear(today.getFullYear() + 1);
            }
            return nextBday;
        }

        function getDaysUntil(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextBday = getNextBirthday(dateStr);
            const diffTime = Math.abs(nextBday - today);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function renderList() {
            const listEl = document.getElementById('birthdayList');
            const emptyEl = document.getElementById('emptyState');

            listEl.innerHTML = '';

            // Calculate statistics
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();

            const filter = document.getElementById('filterType').value;
            const filteredBirthdays = filter === 'All' ? birthdays : birthdays.filter(b => b.type === filter);

            // Update summary card
            document.getElementById('total-count').textContent = `${filteredBirthdays.length} Moment${filteredBirthdays.length !== 1 ? 's' : ''}`;

            const thisMonthCount = filteredBirthdays.filter(b => {
                const bday = new Date(b.date);
                const nextBday = getNextBirthday(b.date);
                return nextBday.getMonth() === thisMonth && nextBday.getFullYear() === thisYear;
            }).length;
            document.getElementById('this-month-count').textContent = thisMonthCount;

            const todayCount = filteredBirthdays.filter(b => getDaysUntil(b.date) === 0).length;
            document.getElementById('today-count').textContent = todayCount;

            // Show/hide empty state
            if (filteredBirthdays.length === 0) {
                emptyEl.classList.remove('hidden');
                emptyEl.classList.add('flex');
                const emptyText = document.querySelector('#emptyState p');
                if (emptyText) {
                    emptyText.textContent = filter === 'All' ? 'No moments yet.' : `No ${filter.toLowerCase()}s yet.`;
                }
                return;
            }
            emptyEl.classList.add('hidden');
            emptyEl.classList.remove('flex');

            filteredBirthdays.sort((a, b) => getDaysUntil(a.date) - getDaysUntil(b.date));

            filteredBirthdays.forEach(person => {
                const daysUntil = getDaysUntil(person.date);
                const bdayDate = new Date(person.date);
                const dateDisplay = bdayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                // UI Logic
                let cardColor = "bg-white border-slate-200";
                let daysText = `<span class="text-primary font-bold text-2xl block">${daysUntil}</span><span class="text-[10px] text-slate-400 uppercase tracking-widest">Days Left</span>`;

                if (daysUntil === 0) {
                    daysText = `<span class="text-pink-600 font-bold text-xl uppercase animate-pulse block">Today!</span>`;
                    cardColor = "bg-gradient-to-r from-pink-50 to-white border-pink-200 ring-2 ring-pink-100";
                } else if (daysUntil === 1) {
                    daysText = `<span class="text-primary font-bold text-xl block">Tomorrow</span>`;
                }

                const div = document.createElement('div');
                div.className = `${cardColor} p-5 rounded-2xl shadow-sm border cursor-pointer hover:shadow-md transition-all duration-200`;
                div.onclick = () => openEditModal(person);

                // Icon and Label Logic
                let iconHtml = '<i class="fa-solid fa-cake-candles"></i>';
                let typeLabel = 'Birthday';
                let iconBg = 'bg-blue-50 border-blue-100 text-blue-600';

                if (person.type === 'Anniversary') {
                    iconHtml = '<i class="fa-solid fa-ring"></i>';
                    typeLabel = 'Anniversary';
                    iconBg = 'bg-purple-50 border-purple-100 text-purple-600';
                } else if (person.type === 'Other') {
                    iconHtml = '<i class="fa-solid fa-star"></i>';
                    typeLabel = person.customType || 'Special Day';
                    iconBg = 'bg-amber-50 border-amber-100 text-amber-600';
                }

                div.innerHTML = `
                    <div class="flex items-center gap-3 w-full">
                        <div class="w-12 h-12 rounded-xl ${iconBg} border flex items-center justify-center text-lg shadow-sm flex-shrink-0">
                            ${iconHtml}
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-slate-800 text-base leading-tight truncate">${person.name}</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-500 font-medium mt-0.5">
                                <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600">${typeLabel}</span>
                                <span>‚Ä¢</span>
                                <span>${dateDisplay}</span>
                            </div>
                        </div>

                        <div class="text-right flex-shrink-0">
                            ${daysUntil === 0 ?
                        `<span class="text-pink-600 font-bold text-sm uppercase animate-pulse block">Today!</span>` :
                        daysUntil === 1 ?
                            `<span class="text-primary font-bold text-sm block">Tomorrow</span>` :
                            `<span class="text-primary font-bold text-xl block">${daysUntil}</span><span class="text-[10px] text-slate-400 uppercase tracking-widest">Days Left</span>`
                    }
                        </div>
                    </div>
                `;
                listEl.appendChild(div);
            });

            checkNotifications();
        }

        // --- Form & Modal ---

        function handleFormSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const name = document.getElementById('nameInput').value.trim();
            const date = document.getElementById('dateInput').value;
            const type = document.getElementById('typeInput').value;
            const customType = document.getElementById('customTypeInput').value.trim();

            // --- 1. DUPLICATE CHECK ---
            // Check if ANY existing birthday has same Name AND Date, excluding current ID (if editing)
            const isDuplicate = birthdays.some(b =>
                b.name.toLowerCase() === name.toLowerCase() &&
                b.date === date &&
                b.id !== id
            );

            if (isDuplicate) {
                showToast('Duplicate: This moment already exists!', true);
                return; // Stop execution, do not save, do not close modal
            }

            const bdayObject = {
                id: id || (Date.now() + Math.random().toString(16).slice(2)),
                name,
                date,
                type,
                customType: type === 'Other' ? customType : null
            };

            saveData(bdayObject);
            showToast(id ? 'Moment updated!' : 'Moment added!');

            // --- 2. CLOSE MODAL ---
            // Explicitly call close modal after successful save
            closeModal();
        }

        function deleteBirthday() {
            const id = document.getElementById('editId').value;
            if (id && confirm("Delete this birthday?")) {
                saveData(null, true, id);
                closeModal();
                showToast('Moment deleted');
            }
        }

        function openModal() {
            document.getElementById('birthdayForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').textContent = 'Add Moment';
            document.getElementById('typeInput').value = 'Birthday';
            toggleCustomType();
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function openEditModal(person) {
            document.getElementById('editId').value = person.id;
            document.getElementById('nameInput').value = person.name;
            document.getElementById('dateInput').value = person.date;
            document.getElementById('typeInput').value = person.type || 'Birthday';
            document.getElementById('customTypeInput').value = person.customType || '';
            toggleCustomType();
            document.getElementById('modalTitle').textContent = 'Edit Moment';
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }

        function closeModalOutside(event) {
            if (event.target.id === 'modalOverlay') closeModal();
        }

        function toggleCustomType() {
            const type = document.getElementById('typeInput').value;
            const container = document.getElementById('customTypeContainer');
            if (type === 'Other') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');

            document.getElementById('toastMsg').textContent = msg;

            if (isError) {
                icon.className = "fa-solid fa-triangle-exclamation text-red-500";
            } else {
                icon.className = "fa-solid fa-check-circle text-green-400";
            }

            toast.style.transform = 'translateY(0)';
            setTimeout(() => toast.style.transform = 'translateY(-10rem)', 3000);
        }

        // --- Notifications ---

        function requestNotificationPermission() {
            if (!("Notification" in window)) return alert("Notifications not supported");
            Notification.requestPermission().then(p => {
                if (p === "granted") {
                    showToast("Notifications enabled!");
                    checkNotifications();
                }
            });
        }

        // --- Notification Settings Functions ---

        function loadNotificationSettings() {
            const stored = localStorage.getItem('notification-settings');
            if (stored) {
                try {
                    notificationSettings = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse notification settings:', e);
                }
            }

            if (currentUser && isFirebaseReady) {
                db.collection('users').doc(currentUser.uid).collection('settings').doc('notifications').get()
                    .then(doc => {
                        if (doc.exists && doc.data().settings) {
                            notificationSettings = doc.data().settings;
                        }
                        renderRemindersList();
                    })
                    .catch(err => console.error('Error loading notification settings:', err));
            } else {
                // Render list immediately for local-only users
                renderRemindersList();
            }

            if (document.getElementById('notifications-enabled')) {
                document.getElementById('notifications-enabled').checked = notificationSettings.enabled;
            }
        }

        function saveNotificationSettings() {
            localStorage.setItem('notification-settings', JSON.stringify(notificationSettings));

            if (currentUser && isFirebaseReady) {
                db.collection('users').doc(currentUser.uid).collection('settings').doc('notifications').set({
                    settings: notificationSettings,
                    updatedAt: new Date().toISOString()
                }).catch(err => console.error('Error saving notification settings:', err));
            }

            renderRemindersList();
        }

        function toggleNotifications() {
            const enabled = document.getElementById('notifications-enabled').checked;
            notificationSettings.enabled = enabled;
            saveNotificationSettings();

            if (enabled) {
                requestNotificationPermission();
            }
        }

        function addReminderPreset(hours, label) {
            const exists = notificationSettings.reminders.some(r => r.hours === hours);
            if (exists) {
                showToast('Reminder already exists', true);
                return;
            }

            const newReminder = {
                id: Date.now().toString(),
                label: label,
                hours: hours
            };

            notificationSettings.reminders.push(newReminder);
            saveNotificationSettings();
            showToast('Reminder added!');
        }

        function addCustomReminder() {
            const hoursInput = document.getElementById('custom-hours');
            const hours = parseInt(hoursInput.value);

            if (isNaN(hours) || hours < 0) {
                showToast('Please enter valid hours', true);
                return;
            }

            const exists = notificationSettings.reminders.some(r => r.hours === hours);
            if (exists) {
                showToast('Reminder already exists', true);
                return;
            }

            let label;
            if (hours === 0) {
                label = 'Day of (12 AM)';
            } else if (hours < 24) {
                label = `${hours} hour${hours > 1 ? 's' : ''} before`;
            } else {
                const days = Math.floor(hours / 24);
                label = `${days} day${days > 1 ? 's' : ''} before`;
            }

            const newReminder = {
                id: Date.now().toString(),
                label: label,
                hours: hours
            };

            notificationSettings.reminders.push(newReminder);
            saveNotificationSettings();
            showToast('Reminder added!');

            hoursInput.value = '';
        }

        function deleteReminder(id) {
            if (notificationSettings.reminders.length <= 1) {
                showToast('Must have at least one reminder', true);
                return;
            }

            notificationSettings.reminders = notificationSettings.reminders.filter(r => r.id !== id);
            saveNotificationSettings();
            showToast('Reminder removed');
        }

        function renderRemindersList() {
            const list = document.getElementById('reminders-list');
            if (!list) return;

            list.innerHTML = '';

            const sorted = [...notificationSettings.reminders].sort((a, b) => a.hours - b.hours);

            sorted.forEach(reminder => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-slate-50 px-4 py-3 rounded-xl hover:bg-slate-100 transition';

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-clock text-primary text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium text-slate-800 text-sm">${reminder.label}</p>
                        </div>
                    </div>
                    ${notificationSettings.reminders.length > 1 ? `
                        <button onclick="deleteReminder('${reminder.id}')" class="text-slate-400 hover:text-red-600 transition px-2">
                            <i class="fa-solid fa-trash text-sm"></i>
                        </button>
                    ` : ''}
                `;

                list.appendChild(div);
            });
        }

        function openSettingsModal() {
            loadNotificationSettings();
            renderRemindersList();
            toggleModal('settings-modal');
        }

        function closeSettingsModal() {
            toggleModal('settings-modal');
        }

        // --- Notifications ---

        function checkNotifications() {
            if (!notificationSettings.enabled || Notification.permission !== "granted") return;

            const now = new Date();

            birthdays.forEach(person => {
                const eventDate = new Date(person.date);

                // Check each configured reminder
                notificationSettings.reminders.forEach(reminder => {
                    // Calculate when this reminder should fire
                    const thisYearEvent = new Date(now.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                    if (thisYearEvent < now) {
                        thisYearEvent.setFullYear(now.getFullYear() + 1);
                    }

                    // Subtract reminder hours to get notification time
                    const notificationTime = new Date(thisYearEvent.getTime() - (reminder.hours * 60 * 60 * 1000));

                    // Check if we should notify now (within the current day and hour)
                    if (notificationTime.getDate() === now.getDate() &&
                        notificationTime.getMonth() === now.getMonth() &&
                        notificationTime.getFullYear() === now.getFullYear() &&
                        notificationTime.getHours() === now.getHours()) {

                        const notifKey = `notified-${person.id}-${reminder.id}-${now.getFullYear()}`;
                        if (!sessionStorage.getItem(notifKey)) {
                            let message;
                            if (reminder.hours === 0) {
                                message = `Today is ${person.name}'s ${person.customType || person.type}!`;
                            } else if (reminder.hours < 24) {
                                message = `${person.name}'s ${person.customType || person.type} is in ${reminder.hours} hours!`;
                            } else {
                                const days = Math.floor(reminder.hours / 24);
                                message = `${person.name}'s ${person.customType || person.type} is in ${days} day${days > 1 ? 's' : ''}!`;
                            }

                            new Notification("Special Day Reminder! üéâ", { body: message });
                            sessionStorage.setItem(notifKey, 'true');
                        }
                    }
                });
            });
        }

        // --- Dynamic PWA Manifest ---
        function setupManifest() {
            const manifest = {
                "name": "Moments",
                "short_name": "Moments",
                "display": "standalone",
                "background_color": "#f3f4f6",
                "theme_color": "#4f46e5",
                "icons": [{
                    "src": "icon.png",
                    "sizes": "192x192",
                    "type": "image/png"
                }]
            };
            const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = URL.createObjectURL(blob);
            document.head.appendChild(link);
        }

        // --- Hide FAB on Scroll ---
        let scrollTimer = null;
        const fabButton = document.getElementById('fabButton');

        window.addEventListener('scroll', () => {
            // Hide button while scrolling
            fabButton.style.opacity = '0';
            fabButton.style.transform = 'scale(0.8)';
            fabButton.style.pointerEvents = 'none';

            // Clear existing timer
            clearTimeout(scrollTimer);

            // Show button after scrolling stops (300ms delay)
            scrollTimer = setTimeout(() => {
                fabButton.style.opacity = '1';
                fabButton.style.transform = 'scale(1)';
                fabButton.style.pointerEvents = 'auto';
            }, 300);
        });

    </script>
</body>

</html>