<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moments</title>
    <link rel="icon" href="icon.png" type="image/png">

    <!-- PWA Settings -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Moments">

    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
            user-select: none;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-animate {
            animation: slideUp 0.3s ease-out forwards;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Card Interactions */
        .birthday-card {
            transition: transform 0.2s, box-shadow 0.2s;
            aspect-ratio: 2/3;
            /* Enforce 4x6 portrait ratio */
        }

        .birthday-card:active {
            transform: scale(0.96);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen pb-24">

    <!-- Header -->
    <header class="bg-indigo-600 text-white pt-12 pb-6 px-6 shadow-lg rounded-b-3xl relative overflow-hidden mb-6">
        <div
            class="absolute top-0 right-0 opacity-10 text-9xl transform translate-x-10 -translate-y-10 pointer-events-none">
            <i class="fa-solid fa-cake-candles"></i>
        </div>

        <div class="relative z-10 flex justify-between items-start mb-4">
            <div>
                <p class="text-indigo-200 text-xs font-bold uppercase tracking-wider" id="currentDateDisplay">Loading...
                </p>
                <div class="flex items-center gap-3 mt-1">
                    <h1 class="text-3xl font-bold">Moments</h1>
                    <select id="filterType" onchange="renderList()"
                        class="bg-indigo-500/30 text-white text-xs font-bold rounded-lg px-2 py-1 border border-indigo-400/30 focus:outline-none focus:bg-indigo-500/50">
                        <option value="All">All</option>
                        <option value="Birthday">Birthdays</option>
                        <option value="Anniversary">Anniversaries</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <p id="storage-indicator" class="text-xs text-indigo-200 mt-1 flex items-center gap-1">
                    <i class="fa-solid fa-database"></i> <span>Local Storage</span>
                </p>
            </div>

            <div class="flex gap-2">
                <!-- Login Button -->
                <button id="login-btn" onclick="googleLogin()"
                    class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-3 py-2 rounded-full text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-brands fa-google"></i> Sync
                </button>

                <!-- Profile -->
                <div id="user-profile" class="hidden relative">
                    <img id="user-avatar" src="" onclick="toggleProfileMenu()"
                        class="w-9 h-9 rounded-full border-2 border-indigo-300 cursor-pointer" alt="Profile">
                    <div id="profile-menu"
                        class="hidden absolute top-10 right-0 bg-white text-gray-800 shadow-xl rounded-xl p-2 min-w-[120px] z-50">
                        <button onclick="googleLogout()"
                            class="w-full text-left text-sm text-red-500 font-medium hover:bg-red-50 px-3 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-right-from-bracket"></i> Logout
                        </button>
                    </div>
                </div>

                <!-- Bell -->
                <button onclick="requestNotificationPermission()"
                    class="bg-white/20 hover:bg-white/30 p-2 w-9 h-9 rounded-full backdrop-blur-sm transition flex items-center justify-center">
                    <i class="fa-solid fa-bell text-white text-sm"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="px-4 w-full max-w-7xl mx-auto" id="appContent">
        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center mt-20 text-gray-400">
            <i class="fa-regular fa-calendar-plus text-6xl mb-4 text-gray-300"></i>
            <p class="text-lg font-medium text-gray-500">No moments yet!</p>
            <p class="text-sm">Tap + to add one.</p>
        </div>

        <!-- Birthday Grid (Changed to Grid for side-by-side) -->
        <div id="birthdayList"
            class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
            <!-- Cards injected via JS -->
        </div>
    </main>

    <!-- Floating Action Button -->
    <button id="fabButton" onclick="openModal()"
        class="fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-xl shadow-indigo-400/40 flex items-center justify-center text-2xl hover:bg-indigo-700 active:scale-90 transition-all duration-300 z-30">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Add/Edit Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity"
        onclick="closeModalOutside(event)">
        <div id="modalContent"
            class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 modal-animate max-w-md mx-auto w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800" id="modalTitle">Add Moment</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <form id="birthdayForm" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="editId">

                <div class="mb-4">
                    <label class="block text-gray-500 text-xs font-bold uppercase mb-2">Name</label>
                    <div class="relative">
                        <i class="fa-regular fa-user absolute left-4 top-4 text-gray-400"></i>
                        <input type="text" id="nameInput" required placeholder="e.g. John Doe"
                            class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-500 text-xs font-bold uppercase mb-2">Type</label>
                    <select id="typeInput" onchange="toggleCustomType()"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition text-gray-700 appearance-none">
                        <option value="Birthday">Birthday üéÇ</option>
                        <option value="Anniversary">Anniversary üíç</option>
                        <option value="Other">Other ‚ú®</option>
                    </select>
                </div>

                <div id="customTypeContainer" class="mb-4 hidden">
                    <label class="block text-gray-500 text-xs font-bold uppercase mb-2">Custom Label</label>
                    <input type="text" id="customTypeInput" placeholder="e.g. Graduation"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-500 text-xs font-bold uppercase mb-2">Date</label>
                    <input type="date" id="dateInput" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition text-gray-700">
                </div>

                <div class="flex gap-3">
                    <button type="button" id="deleteBtn" onclick="deleteBirthday()"
                        class="hidden flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold hover:bg-red-100 transition">
                        Delete
                    </button>
                    <button type="submit"
                        class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast"
        class="fixed top-4 left-4 right-4 bg-gray-800 text-white p-4 rounded-xl shadow-2xl transform -translate-y-40 transition-transform duration-300 z-50 flex items-center gap-3 justify-center">
        <i class="fa-solid fa-circle-info text-blue-400" id="toastIcon"></i>
        <span id="toastMsg" class="font-medium text-sm">Action Successful</span>
    </div>

    <!-- Install App Banner -->
    <div id="install-banner"
        class="hidden bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 shadow-lg z-20">
        <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 flex-1">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-download text-blue-600 text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm">Install Moments</p>
                    <p class="text-xs text-blue-100">Add to home screen for quick access</p>
                </div>
            </div>
            <div class="flex gap-2 flex-shrink-0">
                <button onclick="installApp()"
                    class="bg-white text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-50 active:scale-95 transition">
                    Install
                </button>
                <button onclick="dismissInstallBanner()" class="text-white hover:text-blue-100 p-2">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyC5bgHDNhcrJfhSweCQz0CA0uEEuc05um0",
            authDomain: "birthday-reminder-yuva.firebaseapp.com",
            projectId: "birthday-reminder-yuva",
            storageBucket: "birthday-reminder-yuva.firebasestorage.app",
            messagingSenderId: "615674453004",
            appId: "1:615674453004:web:3d4e6d8f9030645249a229",
            measurementId: "G-6ZVBS4Y7TX"
        };
        let auth, db, currentUser = null;
        let isFirebaseReady = false;

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            isFirebaseReady = true;

            auth.onAuthStateChanged(async (user) => {
                const wasLoggedOut = currentUser === null;
                currentUser = user;
                updateAuthUI(user);

                if (user && wasLoggedOut) {
                    // User just logged in - sync local data to cloud first
                    await syncLocalToCloud();
                } else if (user) {
                    // User was already logged in - just load cloud data
                    loadFromCloud();
                } else {
                    // User is logged out - load from local storage
                    loadFromLocal();
                }
            });
        } catch (e) {
            console.error("Firebase Init Error:", e);
            loadFromLocal();
        }


        // --- PWA Install Logic ---
        let deferredPrompt;

        // Capture the install prompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing
            e.preventDefault();
            // Save the event for later use
            deferredPrompt = e;

            // Check if user has dismissed the banner before
            const dismissed = localStorage.getItem('install-banner-dismissed');
            if (!dismissed) {
                // Show the install banner
                document.getElementById('install-banner').classList.remove('hidden');
            }
        });

        async function installApp() {
            if (!deferredPrompt) {
                // For iOS: Show instructions since PWA install is not available via API
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    alert('To install:\n1. Tap the Share button\n2. Scroll and tap "Add to Home Screen"\n3. Tap "Add"');
                }
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user's response
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }

            // Clear the deferredPrompt
            deferredPrompt = null;

            // Hide the banner
            document.getElementById('install-banner').classList.add('hidden');
        }

        function dismissInstallBanner() {
            document.getElementById('install-banner').classList.add('hidden');
            // Remember that user dismissed the banner (for 30 days)
            localStorage.setItem('install-banner-dismissed', Date.now());
            setTimeout(() => {
                localStorage.removeItem('install-banner-dismissed');
            }, 30 * 24 * 60 * 60 * 1000); // 30 days
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            document.getElementById('install-banner').classList.add('hidden');
        });

        // ==========================================
        // APP LOGIC
        // ==========================================
        let birthdays = [];

        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentDate();
            setupManifest();
            if (!isFirebaseReady) loadFromLocal();
        });

        // --- Auth Functions ---
        function googleLogin() {
            if (!isFirebaseReady) return alert("Firebase not configured.");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => alert(err.message));
        }

        function googleLogout() {
            auth.signOut();
            birthdays = [];
            loadFromLocal();
        }

        function updateAuthUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userProfile = document.getElementById('user-profile');
            const userAvatar = document.getElementById('user-avatar');
            const storageInd = document.getElementById('storage-indicator');

            if (user) {
                loginBtn.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userAvatar.src = user.photoURL;
                storageInd.innerHTML = `<i class="fa-brands fa-google"></i> <span>Synced to Cloud</span>`;
            } else {
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden');
                storageInd.innerHTML = `<i class="fa-solid fa-database"></i> <span>Local Storage</span>`;
            }
            document.getElementById('profile-menu').classList.add('hidden');
        }

        function toggleProfileMenu() {
            document.getElementById('profile-menu').classList.toggle('hidden');
        }

        // --- Data Handling ---

        function loadFromLocal() {
            const stored = localStorage.getItem('birthdays');
            birthdays = stored ? JSON.parse(stored) : [];
            renderList();
        }

        async function syncLocalToCloud() {
            if (!currentUser || !isFirebaseReady) return;

            // Get local storage data
            const stored = localStorage.getItem('birthdays');
            const localBirthdays = stored ? JSON.parse(stored) : [];

            if (localBirthdays.length === 0) {
                // No local data to sync, just load from cloud
                loadFromCloud();
                return;
            }

            try {
                const userRef = db.collection('users').doc(currentUser.uid).collection('birthdays');

                // Fetch existing cloud data
                const snapshot = await userRef.get();
                const cloudBirthdays = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Deduplicate: only add local items that don't exist in cloud
                // Duplicate check: same name (case-insensitive) AND same date
                const newEntries = localBirthdays.filter(local => {
                    const isDuplicate = cloudBirthdays.some(cloud =>
                        cloud.name.toLowerCase() === local.name.toLowerCase() &&
                        cloud.date === local.date
                    );
                    return !isDuplicate;
                });

                // Upload new entries to cloud
                const uploadPromises = newEntries.map(entry => {
                    const { id, ...data } = entry; // Remove local ID
                    return userRef.add(data);
                });

                await Promise.all(uploadPromises);

                // Clear local storage after successful sync
                localStorage.removeItem('birthdays');

                // Show sync result to user
                if (newEntries.length > 0) {
                    showToast(`Synced ${newEntries.length} moment${newEntries.length > 1 ? 's' : ''} to cloud!`);
                } else {
                    showToast('All moments already synced!');
                }

                // Now load from cloud (will set up real-time listener)
                loadFromCloud();
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Sync failed. Loading cloud data...', true);
                loadFromCloud();
            }
        }

        function loadFromCloud() {
            if (!currentUser) return;
            const userRef = db.collection('users').doc(currentUser.uid).collection('birthdays');

            userRef.onSnapshot(snapshot => {
                birthdays = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderList();
            });
        }

        function saveData(birthdayData, isDelete = false, idToDelete = null) {
            if (currentUser && isFirebaseReady) {
                // Cloud Mode
                const userRef = db.collection('users').doc(currentUser.uid).collection('birthdays');
                if (isDelete && idToDelete) {
                    userRef.doc(idToDelete).delete();
                } else if (birthdayData) {
                    if (birthdayData.id) {
                        const { id, ...data } = birthdayData;
                        userRef.doc(id).set(data);
                    } else {
                        userRef.add(birthdayData);
                    }
                }
            } else {
                // Local Mode
                if (isDelete && idToDelete) {
                    birthdays = birthdays.filter(b => b.id !== idToDelete);
                } else if (birthdayData) {
                    const index = birthdays.findIndex(b => b.id === birthdayData.id);
                    if (index !== -1) {
                        birthdays[index] = birthdayData;
                    } else {
                        birthdays.push(birthdayData);
                    }
                }
                localStorage.setItem('birthdays', JSON.stringify(birthdays));
                renderList();
            }
        }

        // --- Business Logic ---

        function updateCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('en-US', options);
        }

        function getNextBirthday(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const birthDate = new Date(dateStr);
            let nextBday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());

            if (nextBday < today) {
                nextBday.setFullYear(today.getFullYear() + 1);
            }
            return nextBday;
        }

        function getDaysUntil(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextBday = getNextBirthday(dateStr);
            const diffTime = Math.abs(nextBday - today);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function renderList() {
            const listEl = document.getElementById('birthdayList');
            const emptyEl = document.getElementById('emptyState');

            listEl.innerHTML = '';

            if (birthdays.length === 0) {
                emptyEl.classList.remove('hidden');
                return;
            }
            emptyEl.classList.add('hidden');

            const filter = document.getElementById('filterType').value;
            const filteredBirthdays = birthdays.filter(b => {
                if (filter === 'All') return true;
                return b.type === filter;
            });

            if (filteredBirthdays.length === 0) {
                emptyEl.classList.remove('hidden');
                // Update empty state text based on filter
                const emptyText = document.querySelector('#emptyState p.text-lg');
                emptyText.textContent = filter === 'All' ? "No moments yet!" : `No ${filter.toLowerCase()}s yet!`;
                return;
            }
            emptyEl.classList.add('hidden');

            filteredBirthdays.sort((a, b) => getDaysUntil(a.date) - getDaysUntil(b.date));

            filteredBirthdays.forEach(person => {
                const daysUntil = getDaysUntil(person.date);
                const bdayDate = new Date(person.date);
                const dateDisplay = bdayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                // UI Logic
                let cardColor = "bg-white border-gray-100";
                let daysText = `<span class="text-indigo-600 font-bold text-2xl block">${daysUntil}</span><span class="text-[10px] text-gray-400 uppercase tracking-widest">Days Left</span>`;

                if (daysUntil === 0) {
                    daysText = `<span class="text-pink-600 font-bold text-xl uppercase animate-pulse block">Today!</span>`;
                    cardColor = "bg-gradient-to-b from-pink-50 to-white border-pink-200 shadow-md ring-2 ring-pink-100";
                } else if (daysUntil === 1) {
                    daysText = `<span class="text-indigo-600 font-bold text-xl block">Tomorrow</span>`;
                }

                const div = document.createElement('div');
                // Updated Card Style: Vertical flex, Aspect Ratio 2/3, Centered content
                div.className = `${cardColor} p-4 rounded-2xl shadow-sm border flex flex-col justify-between items-center text-center birthday-card cursor-pointer relative overflow-hidden hover:shadow-lg hover:-translate-y-1 hover:border-indigo-300 transition-all duration-200`;
                div.onclick = () => openEditModal(person);

                // Icon and Label Logic
                let iconHtml = '<i class="fa-solid fa-cake-candles"></i>';
                let typeLabel = 'Birthday';

                if (person.type === 'Anniversary') {
                    iconHtml = '<i class="fa-solid fa-ring"></i>';
                    typeLabel = 'Anniversary';
                } else if (person.type === 'Other') {
                    iconHtml = '<i class="fa-solid fa-star"></i>';
                    typeLabel = person.customType || 'Special Day';
                }

                div.innerHTML = `
                    <div class="mt-2 w-14 h-14 rounded-full bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xl shadow-inner mb-2">
                        ${iconHtml}
                    </div>
                    
                    <div class="flex-1 flex flex-col justify-center w-full overflow-hidden px-1">
                        <h3 class="font-bold text-gray-800 text-lg leading-tight truncate w-full">${person.name}</h3>
                        <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider mb-1">${typeLabel}</p>
                        <p class="text-xs text-gray-500 font-medium bg-gray-100 py-1 px-2 rounded-full mx-auto inline-block">${dateDisplay}</p>
                    </div>
                    
                    <div class="mt-3 w-full border-t border-gray-100 pt-3">
                        ${daysText}
                    </div>
                `;
                listEl.appendChild(div);
            });

            checkNotifications();
        }

        // --- Form & Modal ---

        function handleFormSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const name = document.getElementById('nameInput').value.trim();
            const date = document.getElementById('dateInput').value;
            const type = document.getElementById('typeInput').value;
            const customType = document.getElementById('customTypeInput').value.trim();

            // --- 1. DUPLICATE CHECK ---
            // Check if ANY existing birthday has same Name AND Date, excluding current ID (if editing)
            const isDuplicate = birthdays.some(b =>
                b.name.toLowerCase() === name.toLowerCase() &&
                b.date === date &&
                b.id !== id
            );

            if (isDuplicate) {
                showToast('Duplicate: This moment already exists!', true);
                return; // Stop execution, do not save, do not close modal
            }

            const bdayObject = {
                id: id || (Date.now() + Math.random().toString(16).slice(2)),
                name,
                date,
                type,
                customType: type === 'Other' ? customType : null
            };

            saveData(bdayObject);
            showToast(id ? 'Moment updated!' : 'Moment added!');

            // --- 2. CLOSE MODAL ---
            // Explicitly call close modal after successful save
            closeModal();
        }

        function deleteBirthday() {
            const id = document.getElementById('editId').value;
            if (id && confirm("Delete this birthday?")) {
                saveData(null, true, id);
                closeModal();
                showToast('Moment deleted');
            }
        }

        function openModal() {
            document.getElementById('birthdayForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').textContent = 'Add Moment';
            document.getElementById('typeInput').value = 'Birthday';
            toggleCustomType();
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function openEditModal(person) {
            document.getElementById('editId').value = person.id;
            document.getElementById('nameInput').value = person.name;
            document.getElementById('dateInput').value = person.date;
            document.getElementById('typeInput').value = person.type || 'Birthday';
            document.getElementById('customTypeInput').value = person.customType || '';
            toggleCustomType();
            document.getElementById('modalTitle').textContent = 'Edit Moment';
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }
        function closeModalOutside(e) {
            if (e.target.id === 'modalOverlay') closeModal();
        }

        function toggleCustomType() {
            const type = document.getElementById('typeInput').value;
            const container = document.getElementById('customTypeContainer');
            if (type === 'Other') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');

            document.getElementById('toastMsg').textContent = msg;

            if (isError) {
                icon.className = "fa-solid fa-triangle-exclamation text-red-500";
            } else {
                icon.className = "fa-solid fa-check-circle text-green-400";
            }

            toast.style.transform = 'translateY(0)';
            setTimeout(() => toast.style.transform = 'translateY(-10rem)', 3000);
        }

        // --- Notifications ---

        function requestNotificationPermission() {
            if (!("Notification" in window)) return alert("Notifications not supported");
            Notification.requestPermission().then(p => {
                if (p === "granted") {
                    showToast("Notifications enabled!");
                    checkNotifications();
                }
            });
        }

        function checkNotifications() {
            if (Notification.permission !== "granted") return;
            const today = new Date();
            birthdays.forEach(person => {
                const bday = new Date(person.date);
                if (bday.getMonth() === today.getMonth() && bday.getDate() === today.getDate()) {
                    const notifKey = `notified-${person.id}-${today.getFullYear()}`;
                    if (!sessionStorage.getItem(notifKey)) {
                        new Notification("Special Day! üéâ", { body: `Today is ${person.name}'s special day!` });
                        sessionStorage.setItem(notifKey, 'true');
                    }
                }
            });
        }

        // --- Dynamic PWA Manifest ---
        function setupManifest() {
            const manifest = {
                "name": "Moments",
                "short_name": "Moments",
                "display": "standalone",
                "background_color": "#f3f4f6",
                "theme_color": "#4f46e5",
                "icons": [{
                    "src": "icon.png",
                    "sizes": "192x192",
                    "type": "image/png"
                }]
            };
            const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = URL.createObjectURL(blob);
            document.head.appendChild(link);
        }

        // --- Hide FAB on Scroll ---
        let scrollTimer = null;
        const fabButton = document.getElementById('fabButton');

        window.addEventListener('scroll', () => {
            // Hide button while scrolling
            fabButton.style.opacity = '0';
            fabButton.style.transform = 'scale(0.8)';
            fabButton.style.pointerEvents = 'none';

            // Clear existing timer
            clearTimeout(scrollTimer);

            // Show button after scrolling stops (300ms delay)
            scrollTimer = setTimeout(() => {
                fabButton.style.opacity = '1';
                fabButton.style.transform = 'scale(1)';
                fabButton.style.pointerEvents = 'auto';
            }, 300);
        });

    </script>
</body>

</html>